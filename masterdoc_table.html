<!doctype html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Driver Data Explorer - USOWN Scout</title>
  <style>
    :root {
      --bg: #0b0d12;
      --panel: #121622;
      --panel-2: #0f1320;
      --accent: #3dd6c1;
      --accent-soft: rgba(61, 214, 193, 0.15);
      --text: #f2f5ff;
      --muted: #9aa3b5;
      --border: #1f2534;
      --shadow: 0 10px 30px rgba(0, 0, 0, 0.35);
      --font: "Manrope", "Segoe UI", sans-serif;
    }
    * { box-sizing: border-box; }
    body {
      margin: 0;
      font-family: var(--font);
      background: radial-gradient(120% 120% at 10% 10%, #101527 0%, #080a0f 55%);
      color: var(--text);
      min-height: 100vh;
    }
    .topnav {
      background: var(--panel);
      border-bottom: 1px solid var(--border);
      padding: 12px 28px;
      display: flex;
      gap: 20px;
      align-items: center;
      flex-wrap: wrap;
    }
    .topnav a {
      color: var(--muted);
      text-decoration: none;
      font-size: 14px;
      font-weight: 500;
      padding: 8px 12px;
      border-radius: 8px;
      transition: all 120ms ease;
    }
    .topnav a:hover {
      color: var(--accent);
      background: var(--accent-soft);
    }
    .topnav a.active {
      color: var(--accent);
      background: var(--accent-soft);
      border: 1px solid var(--accent);
    }
    .brand-header {
      background: var(--panel-2);
      border-bottom: 1px solid var(--border);
      padding: 24px 28px 16px;
      text-align: center;
    }
    .brand-title {
      font-size: 32px;
      font-weight: 700;
      margin: 0 0 8px;
      letter-spacing: -0.02em;
    }
    .brand-subtitle {
      color: var(--muted);
      font-size: 15px;
      margin: 0 0 12px;
      line-height: 1.5;
    }
    .brand-links {
      display: flex;
      gap: 20px;
      justify-content: center;
      flex-wrap: wrap;
      font-size: 13px;
    }
    .brand-links a {
      color: var(--accent);
      text-decoration: none;
      transition: opacity 120ms ease;
    }
    .brand-links a:hover {
      opacity: 0.7;
    }
    .content-wrapper {
      padding: 20px;
    }
    header {
      margin-bottom: 20px;
    }
    h1 { margin: 0 0 8px; letter-spacing: -0.01em; font-weight: 700; font-size: 28px; }
    .tagline { color: var(--muted); font-size: 14px; margin-bottom: 16px; }
    .controls { display: flex; gap: 10px; flex-wrap: wrap; margin-bottom: 16px; }
    input, select {
      background: var(--panel);
      color: var(--text);
      border: 1px solid var(--border);
      border-radius: 12px;
      padding: 10px 12px;
      font-size: 14px;
      outline: none;
    }
    input { min-width: 250px; }
    input:focus, select:focus { border-color: var(--accent); box-shadow: 0 0 0 2px var(--accent-soft); }
    .panel {
      background: var(--panel);
      border: 1px solid var(--border);
      border-radius: 16px;
      box-shadow: var(--shadow);
      overflow: hidden;
    }
    .table-container {
      overflow-x: auto;
      max-height: calc(100vh - 220px);
    }
    table {
      width: 100%;
      border-collapse: collapse;
      font-size: 13px;
    }
    thead {
      position: sticky;
      top: 0;
      background: var(--panel-2);
      z-index: 10;
    }
    th {
      padding: 12px 10px;
      text-align: left;
      border-bottom: 2px solid var(--border);
      color: var(--text);
      font-weight: 600;
      letter-spacing: 0.01em;
      cursor: pointer;
      user-select: none;
      white-space: nowrap;
      position: relative;
    }
    th:hover { background: var(--accent-soft); }
    th.sortable::after {
      content: '⇅';
      margin-left: 6px;
      color: var(--muted);
      font-size: 10px;
    }
    th.sort-asc::after {
      content: '↑';
      color: var(--accent);
    }
    th.sort-desc::after {
      content: '↓';
      color: var(--accent);
    }
    td {
      padding: 10px;
      border-bottom: 1px solid var(--border);
    }
    tr:hover td {
      background: var(--accent-soft);
    }
    tr:last-child td { border-bottom: none; }
    .badge {
      display: inline-block;
      padding: 3px 8px;
      border-radius: 999px;
      font-size: 11px;
      background: var(--panel-2);
      border: 1px solid var(--border);
    }
    .badge.yes {
      background: rgba(46, 160, 67, 0.2);
      border-color: #2ea043;
      color: #4ac26b;
    }
    .info-bar {
      padding: 12px 16px;
      background: var(--panel-2);
      border-bottom: 1px solid var(--border);
      display: flex;
      justify-content: space-between;
      align-items: center;
      font-size: 13px;
      color: var(--muted);
    }
    .pagination {
      display: flex;
      gap: 8px;
      align-items: center;
    }
    button {
      background: var(--panel);
      color: var(--text);
      border: 1px solid var(--border);
      border-radius: 8px;
      padding: 6px 12px;
      font-size: 13px;
      cursor: pointer;
      transition: all 120ms ease;
    }
    button:hover:not(:disabled) {
      border-color: var(--accent);
      background: var(--accent-soft);
    }
    button:disabled {
      opacity: 0.4;
      cursor: not-allowed;
    }
    .score-cell {
      font-weight: 600;
    }
  </style>
</head>
<body>
  <nav class="topnav">
    <a href="driver_profiles.html">Driver Profiles</a>
    <a href="masterdoc_table.html" class="active">Data Table</a>
    <a href="driver_comparison.html">Compare Drivers</a>
    <a href="advancement_pathways.html">Advancement Pathways</a>
    <a href="age_analysis.html">Age Analysis</a>
    <a href="statistics_guide.html">Statistics Guide</a>
  </nav>
  
  <div class="brand-header">
    <h1 class="brand-title">USOWN Scout by USOpenWheelNation</h1>
    <p class="brand-subtitle">An analysis of IndyCar prospects utilizing USF Pro Championships race results from 2015-2025.</p>
    <div class="brand-links">
      <a href="https://usopenWheelNation.com" target="_blank" rel="noopener">Visit USOpenWheelNation.com →</a>
      <span style="color: var(--muted);">•</span>
      <a href="mailto:fuhreredward@gmail.com">Contact: fuhreredward@gmail.com</a>
    </div>
  </div>
  
  <div class="content-wrapper">
  <header>
    <h1>Driver Data Explorer</h1>
    <div class="tagline">Sortable table view of masterdoc_with_scores.csv. Click column headers to sort.</div>
    <div class="controls">
      <input id="search" placeholder="Search by driver name, team, series..." />
      <select id="seriesFilter">
        <option value="">All series</option>
      </select>
      <select id="yearFilter">
        <option value="">All years</option>
      </select>
      <select id="pageSize">
        <option value="50">Show 50 rows</option>
        <option value="100" selected>Show 100 rows</option>
        <option value="250">Show 250 rows</option>
        <option value="500">Show 500 rows</option>
        <option value="all">Show all</option>
      </select>
    </div>
  </header>

  <div class="panel">
    <div class="info-bar">
      <div>Showing <span id="rowCount">0</span> rows</div>
      <div class="pagination">
        <button id="prevPage" disabled>← Prev</button>
        <span id="pageInfo">Page 1</span>
        <button id="nextPage">Next →</button>
      </div>
    </div>
    <div class="table-container">
      <table id="dataTable">
        <thead id="tableHead"></thead>
        <tbody id="tableBody"></tbody>
      </table>
    </div>
  </div>

  <script>
    const CSV_URL = 'masterdoc_with_scores.csv';

    const numberFields = new Set([
      'Age', 'Year', 'AVG Finish', 'TAAF Delta', 'AF YoY Change', 'TAAF Delta YoY Change',
      'Series-Adj AVG Finish', 'Series-Adj TAAF Delta', 'Prospect Score', 'Age Adjustment', 'Age-Adjusted Score'
    ]);

    const toNumber = (value) => {
      const n = parseFloat(value);
      return Number.isFinite(n) ? n : null;
    };

    function parseCSV(text) {
      const lines = text.trim().split(/\r?\n/);
      const headers = lines.shift().split(',').map(h => h.trim());
      return {
        headers,
        rows: lines.map(line => {
          const cols = line.split(',');
          const row = {};
          headers.forEach((h, i) => {
            const raw = (cols[i] ?? '').trim();
            row[h] = numberFields.has(h) ? toNumber(raw) : raw;
          });
          return row;
        })
      };
    }

    function getScoreColor(score) {
      if (!Number.isFinite(score)) return '#7d8590';
      if (score >= 90) return '#1a7f37';
      if (score >= 80) return '#2ea043';
      if (score >= 70) return '#4ac26b';
      if (score >= 60) return '#d4a72c';
      return '#7d8590';
    }

    function formatHeader(header) {
      if (header === 'Age-Adjusted Score') return 'IndyCar Prospect Score';
      return header;
    }

    function formatCell(header, value) {
      if (header === 'Age-Adjusted Score' && Number.isFinite(value)) {
        const color = getScoreColor(value);
        return `<span class="score-cell" style="color:${color}">${value.toFixed(1)}</span>`;
      }
      if (header === 'Advanced to Indy NXT' || header === 'Advanced to IndyCar') {
        const val = (value || '').toLowerCase();
        if (val === 'yes') return '<span class="badge yes">Yes</span>';
        return '';
      }
      if (header === 'Year' || header === 'Age') {
        return Number.isFinite(value) ? Math.round(value) : (value || '—');
      }
      if (Number.isFinite(value)) {
        return value.toFixed(2);
      }
      return value || '—';
    }

    let allData = [];
    let filteredData = [];
    let sortColumn = null;
    let sortDirection = 'asc';
    let currentPage = 1;
    let pageSize = 100;

    function applyFilters() {
      const query = document.getElementById('search').value.toLowerCase();
      const series = document.getElementById('seriesFilter').value;
      const year = document.getElementById('yearFilter').value;

      filteredData = allData.filter(row => {
        const matchQuery = !query || 
          (row['Driver'] || '').toLowerCase().includes(query) ||
          (row['Team'] || '').toLowerCase().includes(query) ||
          (row['Series'] || '').toLowerCase().includes(query);
        const matchSeries = !series || row['Series'] === series;
        const matchYear = !year || String(row['Year']) === year;
        return matchQuery && matchSeries && matchYear;
      });

      if (sortColumn) {
        applySorting();
      }

      currentPage = 1;
      renderTable();
    }

    function applySorting() {
      filteredData.sort((a, b) => {
        const valA = a[sortColumn];
        const valB = b[sortColumn];
        
        if (Number.isFinite(valA) && Number.isFinite(valB)) {
          return sortDirection === 'asc' ? valA - valB : valB - valA;
        }
        
        const strA = String(valA || '');
        const strB = String(valB || '');
        const cmp = strA.localeCompare(strB);
        return sortDirection === 'asc' ? cmp : -cmp;
      });
    }

    function sortBy(column) {
      if (sortColumn === column) {
        sortDirection = sortDirection === 'asc' ? 'desc' : 'asc';
      } else {
        sortColumn = column;
        sortDirection = 'asc';
      }
      applySorting();
      renderTable();
    }

    function renderTable() {
      const tbody = document.getElementById('tableBody');
      const rowCountEl = document.getElementById('rowCount');
      const pageInfoEl = document.getElementById('pageInfo');
      const prevBtn = document.getElementById('prevPage');
      const nextBtn = document.getElementById('nextPage');

      const actualPageSize = pageSize === 'all' ? filteredData.length : parseInt(pageSize);
      const totalPages = Math.ceil(filteredData.length / actualPageSize);
      const startIdx = (currentPage - 1) * actualPageSize;
      const endIdx = Math.min(startIdx + actualPageSize, filteredData.length);
      const pageData = filteredData.slice(startIdx, endIdx);

      tbody.innerHTML = '';
      pageData.forEach(row => {
        const tr = document.createElement('tr');
        allData.headers.forEach(header => {
          const td = document.createElement('td');
          td.innerHTML = formatCell(header, row[header]);
          tr.appendChild(td);
        });
        tbody.appendChild(tr);
      });

      rowCountEl.textContent = filteredData.length;
      pageInfoEl.textContent = pageSize === 'all' ? 'All rows' : `Page ${currentPage} of ${totalPages}`;
      prevBtn.disabled = currentPage <= 1;
      nextBtn.disabled = currentPage >= totalPages || pageSize === 'all';

      // Update header sort indicators
      document.querySelectorAll('th').forEach(th => {
        th.classList.remove('sort-asc', 'sort-desc');
        if (th.dataset.column === sortColumn) {
          th.classList.add(sortDirection === 'asc' ? 'sort-asc' : 'sort-desc');
        }
      });
    }

    function changePage(delta) {
      currentPage += delta;
      renderTable();
    }

    function populateFilters(data) {
      const seriesSelect = document.getElementById('seriesFilter');
      const yearSelect = document.getElementById('yearFilter');

      const series = new Set();
      const years = new Set();
      data.forEach(row => {
        if (row['Series']) series.add(row['Series']);
        if (row['Year']) years.add(row['Year']);
      });

      Array.from(series).sort().forEach(s => {
        const opt = document.createElement('option');
        opt.value = s;
        opt.textContent = s;
        seriesSelect.appendChild(opt);
      });

      Array.from(years).sort((a, b) => b - a).forEach(y => {
        const opt = document.createElement('option');
        opt.value = y;
        opt.textContent = y;
        yearSelect.appendChild(opt);
      });
    }

    async function init() {
      try {
        const text = await fetch(CSV_URL).then(res => {
          if (!res.ok) throw new Error('Fetch failed');
          return res.text();
        });
        const parsed = parseCSV(text);
        allData = parsed;
        allData.headers = parsed.headers;
        filteredData = parsed.rows;

        // Build table header
        const thead = document.getElementById('tableHead');
        const headerRow = document.createElement('tr');
        parsed.headers.forEach(header => {
          const th = document.createElement('th');
          th.textContent = formatHeader(header);
          th.className = 'sortable';
          th.dataset.column = header;
          th.addEventListener('click', () => sortBy(header));
          headerRow.appendChild(th);
        });
        thead.appendChild(headerRow);

        allData = parsed.rows;
        filteredData = [...allData];
        allData.headers = parsed.headers;

        populateFilters(allData);
        renderTable();

        document.getElementById('search').addEventListener('input', applyFilters);
        document.getElementById('seriesFilter').addEventListener('change', applyFilters);
        document.getElementById('yearFilter').addEventListener('change', applyFilters);
        document.getElementById('pageSize').addEventListener('change', (e) => {
          pageSize = e.target.value;
          currentPage = 1;
          renderTable();
        });
        document.getElementById('prevPage').addEventListener('click', () => changePage(-1));
        document.getElementById('nextPage').addEventListener('click', () => changePage(1));

      } catch (err) {
        console.error(err);
        document.body.innerHTML = '<div style="color:#f2f5ff;padding:20px;">Could not load masterdoc_with_scores.csv. Ensure this HTML sits next to the CSV.</div>';
      }
    }

    init();
  </script>
  </div>
</body>
</html>
